---
- name: Install Kubernetes Dashboard
  hosts: all
  become: yes
  vars:
    dashboard_namespace: "kubernetes-dashboard"  # Namespace for Kubernetes dashboard
    helm_release_name: "kubernetes-dashboard"  # Helm release name

  tasks:
    - name: Add kubernetes-dashboard Helm repository
      ansible.builtin.command:
        cmd: helm repo add kubernetes-dashboard https://kubernetes.github.io/dashboard/
    
    - name: Update Helm repositories
      ansible.builtin.command:
        cmd: helm repo update

    - name: Install or upgrade Kubernetes Dashboard
      ansible.builtin.command:
        cmd: helm upgrade --install {{ helm_release_name }} kubernetes-dashboard/kubernetes-dashboard --create-namespace --namespace {{ dashboard_namespace }}
      register: helm_install_output

    - name: Show Helm install output
      debug:
        var: helm_install_output.stdout

    - name: Create directory for dashboard configuration
      ansible.builtin.file:
        path: /tmp/dashboard
        state: directory

    - name: Create ServiceAccount configuration file
      ansible.builtin.copy:
        dest: /tmp/dashboard/service-account.yaml
        content: |
          apiVersion: v1
          kind: ServiceAccount
          metadata:
            name: admin-user
            namespace: {{ dashboard_namespace }}

    - name: Apply ServiceAccount
      ansible.builtin.command:
        cmd: kubectl apply -f /tmp/dashboard/service-account.yaml

    - name: Create ClusterRoleBinding configuration file
      ansible.builtin.copy:
        dest: /tmp/dashboard/clusterrolebinding.yaml
        content: |
          apiVersion: rbac.authorization.k8s.io/v1
          kind: ClusterRoleBinding
          metadata:
            name: admin-user
          roleRef:
            apiGroup: rbac.authorization.k8s.io
            kind: ClusterRole
            name: cluster-admin
          subjects:
          - kind: ServiceAccount
            name: admin-user
            namespace: {{ dashboard_namespace }}

    - name: Apply ClusterRoleBinding
      ansible.builtin.command:
        cmd: kubectl apply -f /tmp/dashboard/clusterrolebinding.yaml