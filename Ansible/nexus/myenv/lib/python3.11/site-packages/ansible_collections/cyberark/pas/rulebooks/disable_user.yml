---
- hosts: all
  connection: local

  collections:
    - cyberark.pas

  tasks:

    - name: Logon to CyberArk Vault using PAS Web Services SDK
      cyberark_authentication:
        api_base_url: "https://BASE_URL"
        validate_certs: false
        username: "USERNAME"
        password: "PASSWORD"

    - name: Disabling a CyberArk User
      cyberark_user:
        username: "{{ username }}" #this is password from the running yml when condition is met
        disabled: true
        cyberark_session: "{{ cyberark_session }}"
      register: cyberarkaction
        
    - name: Debug message
      debug:
        var: cyberarkaction

    - name: Logoff from CyberArk Vault
      cyberark_authentication:
        state: absent
        cyberark_session: "{{ cyberark_session }}"

    - name: Sending an e-mail using Gmail SMTP servers
      community.general.mail:
        host: SMTPSERVER
        port: PORT
        username: username@mail.com
        password: password
        to: First Last <first.last@mail.com>
        subject: Ansible-Rulebook Report
        body: Ansible Rulebook disabled Cyberark user '{{ username }}' due to too many login attempts.
      delegate_to: localhost
