---
- name: Cleanup Harbor Installation
  hosts: all
  become: yes
  vars_files:
    - vars.yml

  vars:
    harbor_version: "v2.11.1"
    harbor_containers:
      - nginx
      - harbor-jobservice
      - harbor-core
      - redis
      - registry
      - harbor-db
      - registryctl
      - harbor-portal
      - harbor-log
    harbor_images:
      - "goharbor/nginx-photon:{{ harbor_version }}"
      - "goharbor/harbor-jobservice:{{ harbor_version }}"
      - "goharbor/harbor-core:{{ harbor_version }}"
      - "goharbor/redis-photon:{{ harbor_version }}"
      - "goharbor/registry-photon:{{ harbor_version }}"
      - "goharbor/harbor-db:{{ harbor_version }}"
      - "goharbor/harbor-registryctl:{{ harbor_version }}"
      - "goharbor/harbor-portal:{{ harbor_version }}"
      - "goharbor/harbor-log:{{ harbor_version }}"
    harbor_data_dir: "/data/harbor"
    harbor_install_dir: "/opt/harbor"

  pre_tasks:
    - name: Record start time
      set_fact:
        start_time: "{{ ansible_date_time.epoch }}"
        
  tasks:
    - name: Stop and remove Harbor containers if they exist
      docker_container:
        name: "{{ item }}"
        state: absent
      with_items: "{{ harbor_containers }}"
      ignore_errors: yes
      failed_when: false

    - name: Remove Harbor Docker images if they exist
      docker_image:
        name: "{{ item }}"
        state: absent
      with_items: "{{ harbor_images }}"
      ignore_errors: yes
      failed_when: false

    - name: Remove Harbor data directory if exists
      file:
        path: "{{ harbor_data_dir }}"
        state: absent
        force: yes
      ignore_errors: yes
      failed_when: false

    - name: Remove Harbor installation directory if exists
      file:
        path: "{{ harbor_install_dir }}"
        state: absent
        force: yes
      ignore_errors: yes
      failed_when: false

    - name: Remove Harbor temporary download if exists
      file:
        path: "/tmp/harbor-offline-installer-{{ harbor_version }}.tgz"
        state: absent
        force: yes
      ignore_errors: yes
      failed_when: false

  post_tasks:
    - name: Record end time
      set_fact:
        end_time: "{{ ansible_date_time.epoch }}"

    - name: Calculate total duration
      set_fact:
        duration: "{{ end_time | int - start_time | int }}"

    - name: Display summary of cleanup task
      debug:
        msg:
          - "Harbor cleanup completed successfully!"
          - "Total time taken: {{ duration }} seconds."
          - "Containers removed: {{ harbor_containers | length }}"
          - "Images removed: {{ harbor_images | length }}"
          - "Data directories cleaned: {{ harbor_data_dir }}, {{ harbor_install_dir }}"
